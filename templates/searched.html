{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Searched</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .fav_icon {
      position: absolute; top: 15px; right: 15px;
      width: 35px; height: 35px; cursor: pointer; border-radius: 50%;
      background-size: contain; background-repeat: no-repeat; z-index: 10; background-color: #fff;
    }
    .favourited { background-image: url('{% static "images/fav_icon_active.png" %}'); background-color: #ff0049; }
    .not_favourited { background-image: url('{% static "images/fav_icon.png" %}'); }
    .video, .audio, .file { position: relative; cursor: pointer; }
    .no-results { text-align: center; padding: 50px; font-size: 18px; color: #aaa; }
    .confirm_popup { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); justify-content: center; align-items: center; }
    .confirm_popup.show { display: flex; }
    .popup_box { background: #fff; border-radius: 8px; padding: 20px 30px; text-align: center; }
    .popup_buttons { display: flex; justify-content: space-around; margin-top: 15px; }
    .popup_buttons button { padding: 8px 20px; border: none; background: #ff0049; color: white; border-radius: 5px; cursor: pointer; }
    /* маленький скелет-заглушка при первом рендере */
    .skeleton { position: relative; overflow: hidden; background: #1b1b1b; border-radius: 12px; min-height: 84px; }
    .skeleton::after { content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent); animation: sh 1.2s infinite; }
    @keyframes sh { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
  </style>
</head>
<body>

<!-- плавное затемнение как на главной -->
<div class="blur_overlay active"></div>

<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Севимлилардан олиб ташлашни хоҳлайсизми?</p>
    <div class="popup_buttons">
      <button id="popup_yes">ҲА</button>
      <button id="popup_no">ЙЎҚ</button>
    </div>
  </div>
</div>

<div class="vertical-waves">
  <div class="wave"></div>
  <div class="wave"></div>
  <div class="wave"></div>
</div>

<div class="search_block">
  <a href="{% url 'index' %}"><div class="back_button"></div></a>
  <form class="searcher">
    <img class="search_icon" src="{% static 'images/search icon.png' %}">
    <input class="searcher_block" placeholder="Қидириш..." autocomplete="off">
  </form>
</div>

<div class="content_body">
  <!-- скелеты на момент загрузки -->
  <div class="skeleton" style="margin:10px 16px;"></div>
  <div class="skeleton" style="margin:10px 16px;"></div>
  <div class="skeleton" style="margin:10px 16px;"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  // ----- helpers -----
  const getCSRF = () => {
    const name = "csrftoken=";
    const parts = document.cookie ? document.cookie.split(";") : [];
    for (let c of parts) {
      c = c.trim();
      if (c.startsWith(name)) return decodeURIComponent(c.slice(name.length));
    }
    return "";
  };
  const getJson = async (url) => {
    try {
      const r = await fetch(url, { credentials: "same-origin" });
      if (!r.ok) return null;
      return await r.json();
    } catch { return null; }
  };
  const toNum = v => Number.isFinite(v) ? v : 0;

  const tg = window.Telegram.WebApp;
  const user = tg?.initDataUnsafe?.user;
  const container = document.querySelector('.content_body');
  const searchInput = document.querySelector('.searcher_block');
  const blur = document.querySelector('.blur_overlay');

  if (!user || !user.id) {
    container.innerHTML = '<div class="no-results">Ошибка авторизации</div>';
    blur?.classList.remove('active');
    return;
  }

  // блокируем submit (пересылка на этот же роут)
  document.querySelector(".searcher").addEventListener("submit", (e) => {
    e.preventDefault();
    const q = searchInput.value.trim();
    if (!q) return;
    blur?.classList.add("active");
    setTimeout(() => {
      window.location.href = `/searched/?query=${encodeURIComponent(q)}`;
    }, 250);
  });

  // ----- избранное -----
  let favIds = [];
  try {
    const favJ = await getJson(`/api/favourites/?telegram_id=${user.id}`);
    favIds = Array.isArray(favJ?.favourites) ? favJ.favourites : [];
  } catch {}

  // ----- собираем весь контент по всем жанрам (default + special groups) -----
  // /api/genres/ → для default: /api/content/<genre_id>/?page=1
  //               для special: /api/groups/<genre_id>/ → для каждой: /api/group/<group_id>/?page=1
  const genres = await getJson('/api/genres/');
  let allItems = [];

  if (Array.isArray(genres) && genres.length) {
    const isSpecial = (g) => (g.kind || g.genre_type || 'default') === 'special';
    const defaults = genres.filter(g => !isSpecial(g));
    const specials = genres.filter(isSpecial);

    // обычные жанры
    const defTasks = defaults.map(g => getJson(`/api/content/${g.id}/?page=1`));
    const defResults = await Promise.all(defTasks);
    defResults.forEach(j => {
      if (!j) return;
      const items = Array.isArray(j.items) ? j.items : [];
      items.forEach(it => {
        allItems.push({
          id: toNum(it.id),
          content_type: it.content_type || it.type || 'file',
          title: it.title || '',
          subtitle: it.subtitle || '',
          duration: it.duration || '',
          telegram_url: it.telegram_url || it.url || '',
          thumbnail: it.thumbnail || it.image || ''
        });
      });
    });

    // спецжанры → группы → контент групп
    for (const sg of specials) {
      const glist = await getJson(`/api/groups/${sg.id}/`);
      const groups = Array.isArray(glist?.groups) ? glist.groups : [];
      if (!groups.length) continue;

      const groupTasks = groups.map(gr => getJson(`/api/group/${gr.id}/?page=1`));
      const groupResults = await Promise.all(groupTasks);
      groupResults.forEach(j => {
        if (!j) return;
        const items = Array.isArray(j.items) ? j.items : [];
        items.forEach(it => {
          allItems.push({
            id: toNum(it.id),
            content_type: it.content_type || it.type || 'file',
            title: it.title || '',
            subtitle: it.subtitle || '',
            duration: it.duration || '',
            telegram_url: it.telegram_url || it.url || '',
            thumbnail: it.thumbnail || it.image || ''
          });
        });
      });
    }
  }

  // fallback
  if (!allItems.length) {
    container.innerHTML = '<div class="no-results">Ничего не найдено</div>';
  }

  // ----- рендер -----
  function renderResults(items) {
    container.innerHTML = '';

    if (!items.length) {
      container.innerHTML = '<div class="no-results">Ничего не найдено</div>';
      return;
    }

    for (const item of items) {
      const wrapper = document.createElement('div');
      wrapper.className = item.content_type; // video | audio | file
      wrapper.style.cursor = "pointer";
      wrapper.setAttribute('data-url', item.telegram_url);

      const isFavourited = favIds.includes(item.id);
      const favClass = isFavourited ? "favourited" : "not_favourited";
      const favIconHTML = `<div class="fav_icon ${favClass}" data-id="${item.id}"></div>`;

      let innerHTML = '';

      if (item.content_type === 'video') {
        innerHTML = `
          <div class="video_thumbnail">
            <img src="${item.thumbnail || ''}" alt="video_thumbnail">
            <div class="video_duration">${item.duration || ''}</div>
          </div>
          ${favIconHTML}
          <div class="video_info">
            <div class="title">${item.title || ''}</div>
            <div class="subtitle">${item.subtitle || ''}</div>
          </div>
        `;
      } else if (item.content_type === 'audio') {
        innerHTML = `
          <div class="audio_menu">
            <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}"></div>
            <div class="audio_duration">${item.duration || ''}</div>
          </div>
          ${favIconHTML}
          <div class="audio_info">
            <div class="title">${item.title || ''}</div>
            <div class="subtitle">${item.subtitle || ''}</div>
          </div>
        `;
      } else {
        innerHTML = `
          <div class="file_menu">
            <div class="static_icon"><img src="{% static 'images/file_icon.png' %}"></div>
            <div class="file_duration">${item.duration || ''}</div>
          </div>
          ${favIconHTML}
          <div class="file_info">
            <div class="title">${item.title || ''}</div>
            <div class="subtitle">${item.subtitle || ''}</div>
          </div>
        `;
      }

      wrapper.innerHTML = innerHTML;
      container.appendChild(wrapper);

      // избранное
      const favIcon = wrapper.querySelector('.fav_icon');
      favIcon.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = parseInt(favIcon.dataset.id);
        const isFav = favIds.includes(id);

        try {
          if (isFav) {
            await fetch(`/api/favourites/remove/${id}/`, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
              },
              body: JSON.stringify({ telegram_id: user.id })
            });
            favIds = favIds.filter(x => x !== id);
            favIcon.classList.remove('favourited');
            favIcon.classList.add('not_favourited');
          } else {
            await fetch(`/api/favourites/add/${id}/`, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
              },
              body: JSON.stringify({ telegram_id: user.id })
            });
            favIds.push(id);
            favIcon.classList.remove('not_favourited');
            favIcon.classList.add('favourited');
          }
        } catch (err) {
          console.error('fav error', err);
        }
      });

      // открытие контента
      wrapper.addEventListener('click', (e) => {
        if (e.target.classList.contains('fav_icon')) return;
        const url = wrapper.getAttribute('data-url');
        if (url) {
          blur?.classList.add('active');
          setTimeout(() => {
            window.location.href = url;
            setTimeout(() => { try { Telegram.WebApp.close(); } catch(e) {} }, 350);
          }, 250);
        }
      });
    }
  }

  // ----- поиск -----
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get("query") || "";
  searchInput.value = initialQuery;

  function filterAndRender(query) {
    const q = (query || '').toLowerCase().trim();
    if (!q) { renderResults(allItems); return; }
    const filtered = allItems.filter(item => {
      const title = (item.title || '').toLowerCase();
      const subtitle = (item.subtitle || '').toLowerCase();
      return title.includes(q) || subtitle.includes(q);
    });
    renderResults(filtered);
  }

  // live-поиск
  searchInput.addEventListener('input', () => filterAndRender(searchInput.value));

  // первичный рендер
  if (initialQuery) filterAndRender(initialQuery);
  else renderResults(allItems);

  requestAnimationFrame(() => blur?.classList.remove('active'));
});
</script>

</body>
</html>
