{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION</title>

  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/index.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="blur_overlay active"></div>

  <div class="vertical-waves">
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>

  <div class="popup_container active" id="authPopup">
    <div class="popup_box">
      <p class="popup_title">Добро пожаловать!</p>
      <p class="popup_subtitle">Введите ваш Telegram username или номер телефона:</p>
      <input type="text" id="userInput" placeholder="@username или +998..." />
      <button onclick="checkUser()">Продолжить</button>
    </div>
  </div>

  <div class="header">
    <div class="header_greeting">
      Hello, <span id="userName">Гость</span>
    </div>
    <a href="{% url 'favourites' %}"><div class="header_icon"><img src="{% static 'images/favourites_icon.png' %}"></div></a>
  </div>

  <div class="main_content">
    <div class="nav_block">
      <a href="{% url 'content' %}?genre_id=1&genre_title=AUDIO"><div class="nav_icon"><img src="{% static 'images/audio_icon.png' %}"><p>AUDIO</p></div></a>
      <a href="{% url 'content' %}?genre_id=2&genre_title=VIDEO"><div class="nav_icon"><img src="{% static 'images/video_icon.png' %}"><p>VIDEO</p></div></a>
      <a href="{% url 'content' %}?genre_id=3&genre_title=PDF"><div class="nav_icon"><img src="{% static 'images/pdf_icon.png' %}"><p>PDF</p></div></a>
      <!-- Добавь другие жанры по аналогии -->
    </div>
  </div>

  <script>
    const popup = document.getElementById("authPopup");
    const userName = document.getElementById("userName");

    const savedName = localStorage.getItem("user_name");
    const savedRes = localStorage.getItem("is_resident");

    if (savedName && savedRes === "true") {
      userName.textContent = savedName;
      popup.classList.remove("active");
      document.querySelector(".blur_overlay").classList.remove("active");
    }

    function checkUser() {
      const input = document.getElementById("userInput").value.trim();
      if (!input) return alert("Введите имя или номер");

      fetch("https://api.ayolclub.uz/en/api/v1/telegram-bot/check-user/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Token": "TOKEN_ЗАМЕНИ"
        },
        body: JSON.stringify({ telegram_id: input })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.data?.residency_active) {
            localStorage.setItem("user_name", data.data.first_name || "Пользователь");
            localStorage.setItem("is_resident", "true");
            userName.textContent = data.data.first_name || "Пользователь";
            popup.classList.remove("active");
            document.querySelector(".blur_overlay").classList.remove("active");
          } else {
            alert("Вы не являетесь резидентом.");
          }
        } else {
          alert("Пользователь не найден.");
        }
      })
      .catch(() => alert("Ошибка запроса."));
    }
  </script>
</body>
</html>
