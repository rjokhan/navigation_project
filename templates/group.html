{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION — Groups</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .header, .header * { box-sizing: border-box !important; }
.header {
  position: fixed !important;
  bottom: calc(env(safe-area-inset-bottom) + 12px) !important;
  left: 50% !important; transform: translateX(-50%) !important;
  width: calc(100vw - 16px) !important; max-width: 640px !important;
  height: 88px !important; padding: 4px !important;
  display: grid !important; grid-template-columns: repeat(5, 1fr) !important; gap: 6px !important;
  overflow: hidden !important; border-radius: 40px !important;
  background: linear-gradient(45deg, rgba(128,26,48,.16), rgba(78,5,21,.28)) !important;
  border: 1px solid #ffffff44 !important; -webkit-backdrop-filter: blur(5px) !important; backdrop-filter: blur(5px) !important;
  z-index: 9999 !important;
}
.header > a { display: block !important; height: 100% !important; }
.header_icon { width: 100% !important; height: 100% !important; border-radius: 32px !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; gap: 6px !important; }
.header_icon img { width: 34px !important; height: 34px !important; object-fit: contain !important; }
.header_icon p { margin: 0 !important; font-size: 10px !important; color: #fff !important; }
.header_icon.active { background-color: #00000066 !important; }

/* узкие экраны */
@media (max-width: 360px) {
  .header { height: 80px !important; gap: 4px !important; }
  .header_icon img { width: 30px !important; height: 30px !important; }
  .header_icon p { font-size: 9px !important; }
}

    /* фон */
    body{ background:#4f0017; color:#fff; font-family:"Raleway",sans-serif; }
    .vertical-waves{ position:fixed; inset:0; z-index:-1; background:#4d0016; }

    /* поиск */
    .search_block{ display:flex; gap:10px; align-items:center; padding:16px; }
    .back_button{ width:60px; height:60px; background:#2e000dc7; border-radius:50%; background-image:url("{% static 'images/back_icon.png' %}"); background-size:contain; }
    .searcher{ flex:1; height:60px; display:flex; align-items:center; gap:10px; background:#2e000dc7; border-radius:30px; }
    .search_icon{ width:22px; height:22px; margin-left:30px; }
    .searcher_block{ flex:1; background:none; border:none; color:#fff; font-size:14px; outline:0; margin-right:20px; }

    /* карточка группы */
    .groups{ padding:0 12px 12px; }
    .group_card{
      position:relative; margin:12px 0; border:1px solid rgba(255,255,255,.25);
      border-radius:16px; overflow:hidden; background:rgba(255,255,255,.04);
      cursor: pointer;
    }
    .group_cover{ position:relative; height:180px; overflow:hidden; }
    .group_cover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .badge{
      position:absolute; top:10px; right:10px; width:28px; height:28px; border-radius:50%;
      background:#ff155d; color:#fff; font:700 12px/28px Inter, sans-serif; text-align:center;
      box-shadow:0 3px 6px rgba(255,21,93,.45);
    }
    .group_body{ padding:12px; }
    .group_title{ font:700 16px/1.3 'Raleway',sans-serif; margin-bottom:6px; }
    .group_desc{
      font:400 13px/1.35 'Inter',sans-serif; opacity:.92; color:#f1f1f1;
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; margin-bottom:10px;
    }
    .group_expert{ font:600 13px/1.3 'Inter',sans-serif; opacity:.9; }

    /* пусто/скелетоны */
    .skeleton{ height:220px; border-radius:12px; margin:12px; background:#1b1b1b; position:relative; overflow:hidden; }
    .skeleton::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent); animation:sh 1.2s infinite; }
    @keyframes sh{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

    .blur_overlay{ position:fixed; inset:0; backdrop-filter:blur(10px); background:rgba(0,0,0,.2); z-index:9998; opacity:0; pointer-events:none; transition:opacity .3s; }
    .blur_overlay.active{ opacity:1; pointer-events:auto; }
  </style>
</head>
<body>

<div class="blur_overlay active"></div>
<div class="vertical-waves"><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>

<!-- NAVBAR -->
<div class="header">
  <a href="{% url 'index' %}"><div class="header_icon"><img src="{% static 'images/home_page.png' %}" alt="Home"><p>A CLUB</p></div></a>
  <a href="{% url 'favourited' %}"><div class="header_icon"><img src="{% static 'images/fav.png' %}" alt="Fav"><p>Севимли</p></div></a>
  <a href="{% url 'profile' %}"><div class="header_icon"><img src="{% static 'images/profile.png' %}" alt="Profile"><p>Профиль</p></div></a>
  <a href="{% url 'chat' %}"><div class="header_icon"><img src="{% static 'images/chat.png' %}" alt="Chat"><p>Чатлар</p></div></a>
  <a href="{% url 'rules' %}"><div class="header_icon"><img src="{% static 'images/rules.png' %}" alt="Rules"><p>Қоидалар</p></div></a>
</div>

<!-- поиск -->
<div class="search_block">
  <a href="{% url 'index' %}"><div class="back_button"></div></a>
  <form class="searcher"><img class="search_icon" src="{% static 'images/search icon.png' %}"><input class="searcher_block" id="q" placeholder="Қидириш..." autocomplete="off"></form>
</div>

<!-- список групп -->
<div class="groups" id="groups">
  <div class="skeleton"></div><div class="skeleton"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const overlay = document.querySelector('.blur_overlay');
  const list = document.getElementById('groups');
  const search = document.getElementById('q');

  const tg = window.Telegram.WebApp;
  const user = tg?.initDataUnsafe?.user;
  if (!user || !user.id) { list.innerHTML = '<div style="padding:16px;opacity:.85">Ошибка авторизации</div>'; return; }

  // параметры жанра
  const qs = new URLSearchParams(location.search);
  const genreId = qs.get('genre_id');

  if (!genreId) { list.innerHTML = '<div style="padding:16px;opacity:.85">Жанр не указан</div>'; return; }

  // утилиты
  const getJson = async (url) => { try{ const r=await fetch(url,{credentials:'same-origin'}); if(!r.ok) return null; return await r.json(); }catch{ return null; } };
  const num = v => Number.isFinite(v) ? v : 0;

  // получаем группы спецжанра (расширенные поля от API)
  const data = await getJson(`/api/groups/${encodeURIComponent(genreId)}/`);
  const groups = Array.isArray(data?.groups) ? data.groups : [];

  // если ничего
  if (!groups.length) { list.innerHTML = '<div style="padding:16px;opacity:.85">Ҳозирча гуруҳлар йўқ</div>'; overlay.classList.remove('active'); return; }

  // готовим данные (используем items_count из API — без лишних запросов)
  let view = groups.map(g => ({
    id: g.id,
    title: g.title || '',
    description: g.description || '',
    expert: g.expert || '',
    cover: g.cover || '',
    total: num(g.items_count)
  }));

  function render(arr){
    list.innerHTML = '';
    arr.forEach(g => {
      const total = g.total > 99 ? '99+' : String(g.total || 0);
      const card = document.createElement('div');
      card.className = 'group_card';
      card.innerHTML = `
        <div class="group_cover">
          <img src="${g.cover || '{% static "images/placeholder_wide.jpg" %}'}" alt="">
          <div class="badge">${total}</div>
        </div>
        <div class="group_body">
          <div class="group_title">${g.title}</div>
          <div class="group_desc">${(g.description || '').replace(/\\n/g,'<br>')}</div>
          ${g.expert ? `<div class="group_expert">Expert: ${g.expert}</div>` : ``}
        </div>`;
      // Переход в контент ГРУППЫ (HTML-страница группового контента)
      card.addEventListener('click', () => {
        const params = new URLSearchParams({ group_id: g.id, group_title: g.title });
        document.querySelector('.blur_overlay').classList.add('active');
        setTimeout(() => { window.location.href = `/group_content/?${params}`; }, 250);
      });
      list.appendChild(card);
    });
  }

  // первый рендер
  render(view);
  requestAnimationFrame(() => overlay.classList.remove('active'));

  // локальный поиск
  document.querySelector('.searcher').addEventListener('submit', e => e.preventDefault());
  search.addEventListener('input', () => {
    const q = search.value.trim().toLowerCase();
    const filtered = view.filter(g =>
      (g.title || '').toLowerCase().includes(q) ||
      (g.description || '').toLowerCase().includes(q) ||
      (g.expert || '').toLowerCase().includes(q)
    );
    render(filtered);
  });

  // плавный навбар
  document.querySelectorAll('.header a').forEach(a => a.addEventListener('click', e => {
    e.preventDefault(); const href=a.getAttribute('href'); overlay.classList.add('active'); setTimeout(()=>location.href=href,300);
  }));
});
</script>

</body>
</html>
