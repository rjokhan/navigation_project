{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION — Group Content</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .audio_menu, .file_menu { display:flex; flex-direction:column; align-items:center; justify-content:center; }

    /* NAVBAR (как на обычном контенте) */
    .header, .header * { box-sizing: border-box !important; }
    .header {
      position: fixed !important;
      bottom: calc(env(safe-area-inset-bottom) + 12px) !important;
      left: 50% !important; transform: translateX(-50%) !important;
      width: calc(100vw - 16px) !important; max-width: 640px !important;
      height: 88px !important; padding: 4px !important;
      display: grid !important; grid-template-columns: repeat(5, 1fr) !important; gap: 6px !important;
      overflow: hidden !important; border-radius: 40px !important;
      background: linear-gradient(45deg, rgba(128,26,48,.16), rgba(78,5,21,.28)) !important;
      border: 1px solid #ffffff44 !important; -webkit-backdrop-filter: blur(5px) !important; backdrop-filter: blur(5px) !important;
      z-index: 9999 !important;
    }
    .header > a { display: block !important; min-width: 0 !important; height: 100% !important; }
    .header_icon {
      width: 100% !important; height: 100% !important;
      border-radius: 32px !important;
      display: flex !important; flex-direction: column !important;
      align-items: center !important; justify-content: center !important;
      padding: 8px 0 !important; gap: 6px !important; min-width: 0 !important; box-sizing: border-box !important;
    }
    .header_icon img { display: block !important; width: 34px !important; height: 34px !important; margin: 0 !important; object-fit: contain !important; }
    .header_icon p { margin: 0 !important; font-size: 10px !important; line-height: 1.2 !important; color: #fff !important; text-align: center !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }
    .header_icon.active { background-color: #00000066 !important; }
    @media (max-width: 360px) {
      .header { height: 80px !important; padding: 4px !important; gap: 4px !important; max-width: none !important; }
      .header_icon { padding: 6px 0 !important; gap: 4px !important; }
      .header_icon img { width: 30px !important; height: 30px !important; }
      .header_icon p { font-size: 9px !important; }
    }

    /* безопасный отступ под navbar — как на обычном */
    html, body { margin: 0 !important; padding-bottom: 120px !important; }

    /* ===== FILTER CHIPS (1-в-1) ===== */
    .filter_bar{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 55px;
      gap: 5px;
      padding: 10px 0 0;
      align-items: center;
    }
    @media (max-width:360px){
      .filter_bar{ gap: 8px; grid-template-columns: 1fr 1fr 1fr 44px; }
    }
    .chip{
      min-width: 0;
      display: inline-flex; align-items: center; justify-content: left; gap: 10px; padding-left: 10px !important;
      padding: 10px 0; border-radius: 999px;
      border: 1px solid #fff; background: transparent; color: #fff;
      font: 600 15px/1 Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      white-space: nowrap; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
      transition: background .2s ease, transform .1s ease;
    }
    .chip:active{ transform: translateY(1px) scale(.98); }
    .chip__dot{
      width: 28px; height: 24px; border-radius: 50%;
      display: grid; place-items: center; background: #ff155d;
      flex: 0 0 24px;
    }
    .chip__icon{ width: 15px; height: 15px; object-fit: contain; filter: invert(1) brightness(200%); }
    .chip.active{ background: #ff155d; }
    .chip.active .chip__dot{ background: #fff; }
    .chip.active .chip__icon{ filter: none; }
    .chip--filter{
      grid-column: 4 / 5;
      padding: 10px; width: 100%; height: 44px; border-radius: 999px; justify-content: center;
      background: #ff155d; border: 1px solid #fff;
    }
    .chip--filter .chip__dot{ background: transparent; }
    .chip--filter .chip__icon{ filter: none; width: 18px; height: 18px; }
    .chip--filter span.label{ display: none; }
    @media (max-width: 360px){
      .chip{ padding: 9px 12px; font-size: 14px; gap: 8px; }
      .chip__dot{ width: 22px; height: 22px; }
      .chip--filter{ height: 40px; }
    }

    /* Toast (тот же) */
    #toast{
      position: fixed; top: -56px; left: 50%; transform: translateX(-50%);
      background: #38b000; color: #fff; font-size: 14px; font-weight: 600;
      padding: 10px 16px; border-radius: 999px; box-shadow: 0 6px 20px rgba(0,0,0,.25);
      z-index: 10000; transition: top .35s;
    }
    #toast.show{ top: 18px; }
  </style>
</head>
<body>

<!-- попап избранного (тот же) -->
<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Севимлилардан олиб ташлашни хоҳлайсизми?</p>
    <div class="popup_buttons">
      <button id="popup_yes">ҲА</button>
      <button id="popup_no">ЙЎҚ</button>
    </div>
  </div>
</div>

<div class="blur_overlay active"></div>
<div class="vertical-waves"><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>

<!-- NAVBAR -->
<div class="header">
  <a href="{% url 'index' %}"><div class="header_icon"><img src="{% static 'images/home_page.png' %}" alt="Home"><p>A CLUB</p></div></a>
  <a href="{% url 'favourited' %}"><div class="header_icon"><img src="{% static 'images/fav.png' %}" alt="Fav"><p>Севимли</p></div></a>
  <a href="{% url 'profile' %}"><div class="header_icon"><img src="{% static 'images/profile.png' %}" alt="Profile"><p>Профиль</p></div></a>
  <a href="{% url 'chat' %}"><div class="header_icon"><img src="{% static 'images/chat.png' %}" alt="Chat"><p>Чатлар</p></div></a>
  <a href="{% url 'rules' %}"><div class="header_icon"><img src="{% static 'images/rules.png' %}" alt="Rules"><p>Қоидалар</p></div></a>
</div>

<!-- Поиск -->
<div class="search_block">
  <a href="{% url 'group' %}"><div class="back_button"></div></a>
  <form class="searcher" onsubmit="event.preventDefault();">
    <img class="search_icon" src="{% static 'images/search icon.png' %}">
    <input class="searcher_block" id="searchInput" placeholder="Қидириш..." autocomplete="off">
  </form>
</div>

<!-- ===== FILTER BAR (иконки те же) ===== -->
<div class="filter_bar" id="filterBar">
  <button class="chip" data-type="audio" aria-pressed="false">
    <span class="chip__dot"><img class="chip__icon" src="{% static 'images/ic_audio2.png' %}" alt=""></span>
    <span>Audio</span>
  </button>
  <button class="chip" data-type="video" aria-pressed="false">
    <span class="chip__dot"><img class="chip__icon" src="{% static 'images/ic_video2.png' %}" alt=""></span>
    <span>Video</span>
  </button>
  <button class="chip" data-type="file" aria-pressed="false">
    <span class="chip__dot"><img class="chip__icon" src="{% static 'images/ic_file2.png' %}" alt=""></span>
    <span>File</span>
  </button>
  <button class="chip chip--filter" id="chipFilter" aria-label="Filter">
    <span class="chip__dot">
      <img class="chip__icon" id="chipFilterIcon" src="{% static 'images/ic_filter2.png' %}" alt="">
    </span>
    <span class="label">Filter</span>
  </button>
</div>

<div id="toast">Выберите формат фильтра</div>

<!-- Заголовок группы (как у жанра) -->
<div class="choosed_genre"><span class="red">A </span><span id="group-title"></span></div>

<!-- Контент -->
<div class="content_body" id="contentBody"></div>

<script>
/* ---------- рендер карточек (как на обычном контенте) ---------- */
function renderItems(container, items, favourites, groupId, groupTitle) {
  items.forEach(item => {
    const isFav = favourites.includes(item.id);
    const favClass = isFav ? 'favourited' : 'not_favourited';
    const safeTitle = String(item.title || '').replace(/'/g,"&#39;");
    const open = `openTelegramAndCollapse('${item.telegram_url}', '${groupId}', '${groupTitle}', '${safeTitle}', '${item.id}')`;

    let block = '';
    if (item.content_type === 'video') {
      block = `<div class="video">
        <div class="video_thumbnail" onclick="${open}">
          <img src="${item.thumbnail || ''}"/>
          <div class="video_duration">${item.duration || ''}</div>
        </div>
        <div class="fav_icon ${favClass}" data-id="${item.id}"></div>
        <div class="video_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    } else if (item.content_type === 'audio') {
      block = `<div class="audio" onclick="${open}">
        <div class="audio_menu">
          <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}" /></div>
          <div class="audio_duration">${item.duration || ''}</div>
        </div>
        <div class="fav_icon ${favClass}" data-id="${item.id}"></div>
        <div class="audio_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    } else {
      block = `<div class="file" onclick="${open}">
        <div class="file_menu">
          <div class="static_icon"><img src="{% static 'images/file_icon.png' %}" /></div>
          <div class="file_duration">${item.duration || ''}</div>
        </div>
        <div class="fav_icon ${favClass}" data-id="${item.id}"></div>
        <div class="file_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    }

    container.insertAdjacentHTML('beforeend', block);
    const favEl = container.lastElementChild.querySelector('.fav_icon');
    favEl.addEventListener('click', async e => {
      e.stopPropagation();
      const id = parseInt(favEl.dataset.id);
      const popup = document.getElementById('popup');

      if (favEl.classList.contains('favourited')) {
        popup.classList.add('show');
        document.getElementById('popup_yes').onclick = async () => {
          await fetch(`/api/favourites/remove/${id}/`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ telegram_id: window.__uid })
          });
          favEl.classList.remove('favourited'); favEl.classList.add('not_favourited');
          popup.classList.remove('show');
        };
        document.getElementById('popup_no').onclick = () => popup.classList.remove('show');
      } else {
        await fetch(`/api/favourites/add/${id}/`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({ telegram_id: window.__uid })
        });
        favEl.classList.remove('not_favourited'); favEl.classList.add('favourited');
        const host = favEl.closest('.video, .audio, .file');
        const explosion = document.createElement('div'); explosion.classList.add('fav_explosion'); host.appendChild(explosion); setTimeout(() => explosion.remove(), 600);
      }
    });
  });
}
</script>

<script>
/* ---------- логика страницы группы + фильтр Clear ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  const contentBody = document.getElementById('contentBody');
  if (!user || !user.id) { contentBody.innerHTML = '<p>Ошибка авторизации</p>'; return; }
  window.__uid = user.id;

  const qs = new URLSearchParams(location.search);
  const groupId = qs.get('group_id');
  const groupTitle = (qs.get('group_title') || '').trim();
  document.getElementById('group-title').textContent = decodeURIComponent(groupTitle || '');
  if (!groupId) { contentBody.innerHTML = '<p>Группа не указана</p>'; return; }

  // favourites
  let favourites = [];
  try{
    const favRes = await fetch(`/api/favourites/?telegram_id=${encodeURIComponent(user.id)}`, { credentials:'same-origin' });
    const favData = await favRes.json();
    favourites = favData?.favourites || [];
  }catch{}

  const toast = document.getElementById('toast');
  function showToast(text, duration=2000){
    const prev = toast.textContent;
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.textContent = prev, 350); }, duration);
  }

  // FILTER UI
  const bar = document.getElementById('filterBar');
  const chips = [...bar.querySelectorAll('.chip:not(.chip--filter)')];
  const filterBtn = document.getElementById('chipFilter');
  const filterIcon = document.getElementById('chipFilterIcon');
  const ICON_FILTER = "{% static 'images/ic_filter2.png' %}";
  const ICON_CLEAR  = "{% static 'images/clear_filters.png' %}";

  let currentType = null; // audio|video|file|null
  function anyActive(){ return chips.some(c => c.classList.contains('active')); }
  function updateFilterIcon(){ filterIcon.setAttribute('src', anyActive() ? ICON_CLEAR : ICON_FILTER); }
  function setActiveChip(el){
    chips.forEach(c => {
      const a = (c===el);
      c.classList.toggle('active', a);
      c.setAttribute('aria-pressed', a ? 'true' : 'false');
    });
    currentType = el ? el.dataset.type : null;
    updateFilterIcon();
  }
  async function clearFilters(){
    chips.forEach(c => { c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
    currentType = null; updateFilterIcon(); await fetchAndRender();
  }

  chips.forEach(chip => {
    chip.addEventListener('click', async () => {
      setActiveChip(chip);
      await fetchAndRender();
    });
  });

  filterBtn.addEventListener('click', async () => {
    if (!anyActive()) { showToast('Выберите формат фильтра'); return; }
    await clearFilters(); showToast('Фильтр очищен');
  });

  // pagination (как у обычного)
  let page = 1, total = 0;
  let allLoadedItems = [];
  async function fetchAndRender(){
    contentBody.innerHTML = page===1 ? '<div class="loading">Юкланяпти...</div>' : contentBody.innerHTML;
    let url = `/api/group/${encodeURIComponent(groupId)}/?page=${page}`;
    if (currentType) url += `&content_type=${encodeURIComponent(currentType)}`;
    const r = await fetch(url, { credentials:'same-origin' });
    const data = await r.json();

    total = data.total || 0;
    const items = data.items || [];
    if (page===1) contentBody.innerHTML = '';
    renderItems(contentBody, items, favourites, groupId, groupTitle);

    allLoadedItems = allLoadedItems.concat(items);

    // скролл к последней карточке (если вернулись из TG)
    const session = localStorage.getItem('last_session');
    const lastTitle = session ? JSON.parse(session).itemTitle : null;
    if (page === 1 && lastTitle) {
      setTimeout(() => {
        const cards = document.querySelectorAll('.video, .audio, .file');
        for (let card of cards) {
          const t = card.querySelector('.title');
          if (t && t.textContent.trim() === lastTitle.trim()) {
            card.scrollIntoView({ behavior:'smooth', block:'start' });
            localStorage.removeItem('last_session');
            break;
          }
        }
      }, 250);
    }
  }

  // Поиск по загруженному (локально)
  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    if (!q) {
      contentBody.innerHTML = '';
      renderItems(contentBody, allLoadedItems, favourites, groupId, groupTitle);
      return;
    }
    const filtered = allLoadedItems.filter(i => {
      const t = (i.title || '').toLowerCase();
      const s = (i.subtitle || '').toLowerCase();
      return t.includes(q) || s.includes(q);
    });
    contentBody.innerHTML = '';
    renderItems(contentBody, filtered, favourites, groupId, groupTitle);
  });

  // первая загрузка
  await fetchAndRender();

  // снять блюр и плавная навигация
  const overlay = document.querySelector('.blur_overlay');
  requestAnimationFrame(() => overlay.classList.remove('active'));
  document.querySelectorAll('.header a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const href = link.getAttribute('href');
      overlay.classList.add('active');
      setTimeout(() => window.location.href = href, 300);
    });
  });
});

/* открыть Telegram и запомнить позицию */
function openTelegramAndCollapse(url, groupId, groupTitle, itemTitle, itemId) {
  localStorage.setItem('last_session', JSON.stringify({ groupId, groupTitle, itemTitle, itemId }));
  window.location.href = url;
  setTimeout(() => { try { Telegram.WebApp.close(); } catch(e) {} }, 500);
}
</script>

</body>
</html>
