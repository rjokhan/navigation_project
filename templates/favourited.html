{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Избранное</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

  <div class="blur_overlay"></div>

  <div class="vertical-waves">
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>

  <!-- Назад и строка поиска -->
  <div class="search_block">
    <a href="{% url 'index' %}"><div class="back_button"></div></a>
    <form class="searcher">
      <img class="search_icon" src="{% static 'images/search icon.png' %}">
      <input class="searcher_block" placeholder="Поиск..." autocomplete="off">
    </form>
  </div>

  <!-- Заголовок -->
  <div class="choosed_genre"><span class="red">A </span>FAVOURITES</div>

  <!-- Контент -->
  <div class="content_body" style="margin-top: 20px;"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.querySelector(".searcher_block");
      const container = document.querySelector(".content_body");

      // Получаем id избранных из localStorage (или через API)
      const userId = localStorage.getItem("telegram_id");
      if (!userId) {
        container.innerHTML = `<div style="font-size: 20px; text-align:center;">Ошибка авторизации</div>`;
        return;
      }

      // Загружаем избранное через API (можно заменить на localStorage если нужно)
      fetch(`/api/favourites/?telegram_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          const favIds = data.favourites || [];
          // Берём все карточки (из localStorage)
          const allCards = JSON.parse(localStorage.getItem("allCards") || "[]");
          // Фильтруем только избранные
          const favourites = allCards.filter(item => favIds.includes(item.id));

          if (favourites.length === 0) {
            container.innerHTML = `<div style="font-size: 20px; text-align:center;">Нет избранного контента</div>`;
            return;
          }

          favourites.forEach(item => {
            let dataUrlAttr = `data-url="${item.telegram_url}"`;
            let block = "";

            if (item.content_type === "video") {
              block = `
                <div class="video fav_item" ${dataUrlAttr}>
                  <div class="video_thumbnail">
                    <img src="${item.thumbnail}" alt="video">
                    <div class="video_duration">${item.duration}</div>
                  </div>
                  <div class="fav_icon favourited"></div>
                  <div class="video_info">
                    <div class="title">${item.title}</div>
                    <div class="subtitle">${item.subtitle || ""}</div>
                  </div>
                </div>
              `;
            } else if (item.content_type === "audio") {
              block = `
                <div class="audio fav_item" ${dataUrlAttr}>
                  <div class="audio_menu">
                    <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}"></div>
                    <div class="audio_duration">${item.duration}</div>
                  </div>
                  <div class="fav_icon favourited"></div>
                  <div class="audio_info">
                    <div class="title">${item.title}</div>
                    <div class="subtitle">${item.subtitle || ""}</div>
                  </div>
                </div>
              `;
            } else if (item.content_type === "file") {
              block = `
                <div class="file fav_item" ${dataUrlAttr}>
                  <div class="file_menu">
                    <div class="static_icon"><img src="{% static 'images/file_icon.png' %}"></div>
                    <div class="file_duration">${item.duration}</div>
                  </div>
                  <div class="fav_icon favourited"></div>
                  <div class="file_info">
                    <div class="title">${item.title}</div>
                    <div class="subtitle">${item.subtitle || ""}</div>
                  </div>
                </div>
              `;
            }

            container.insertAdjacentHTML("beforeend", block);
          });

          // Обработка кликов на все избранные карточки
          document.querySelectorAll('.fav_item').forEach(card => {
            card.addEventListener('click', function() {
              const url = card.getAttribute('data-url');
              if (url) {
                window.location.href = url;
                setTimeout(() => {
                  try { Telegram.WebApp.close(); } catch(e) {}
                }, 400);
              }
            });
          });

        })
        .catch(() => {
          container.innerHTML = `<div style="font-size: 20px; text-align:center;">Ошибка загрузки избранного</div>`;
        });

      // Поиск по избранному
      document.querySelector(".searcher").addEventListener("submit", function(e) {
        e.preventDefault();
        const newQuery = input.value.trim();
        if (newQuery) {
          const encoded = encodeURIComponent(newQuery);
          window.location.href = `/searched/?query=${encoded}`;
        }
      });
    });
  </script>

</body>
</html>
