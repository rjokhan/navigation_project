{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />

  <style>
    .fav_icon {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 35px;
      height: 35px;
      cursor: pointer;
      border-radius: 50%;
      background-size: contain;
      background-repeat: no-repeat;
      z-index: 10;
      background-color: white;
    }
    .not_favourited {
      background-image: url('{% static "images/fav_icon.png" %}');
      background-color: white;
    }
    .favourited {
      background-image: url('{% static "images/fav_icon_active.png" %}');
      background-color: #ff0049;
    }

    /* АНИМАЦИИ */
    @keyframes favPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 73, 0.4); }
      50% { transform: scale(1.3); box-shadow: 0 0 20px 15px rgba(255, 0, 73, 0.25); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 73, 0); }
    }
    .animate-pulse {
      animation: favPulse 0.6s ease-out;
    }
    .fav_explosion {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 150%;
      height: 150%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle, rgba(255, 0, 73, 0.25) 0%, rgba(255, 0, 73, 0) 70%);
      border-radius: 50%;
      animation: explodeFade 0.6s ease-out forwards;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes explodeFade {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.3); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }

    .video, .audio, .file {
      position: relative;
    }

    .confirm_popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .confirm_popup.show {
      display: flex;
    }
    .popup_box {
      background: #fff;
      padding: 25px 30px;
      border-radius: 20px;
      text-align: center;
      font-size: 18px;
    }
    .popup_buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .popup_buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
    }
    .popup_buttons #popup_yes {
      background-color: #ff0049;
      color: white;
    }
    .popup_buttons #popup_no {
      background-color: #ccc;
    }
    .blur_overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      backdrop-filter: blur(10px);
      background: rgba(0, 0, 0, 0.2);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    .blur_overlay.active {
      opacity: 1;
      pointer-events: all;
    }
  </style>
</head>
<body>

<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Хотите удалить из избранного?</p>
    <div class="popup_buttons">
      <button id="popup_yes">Да</button>
      <button id="popup_no">Нет</button>
    </div>
  </div>
</div>

<div class="blur_overlay"></div>

<div class="header">
  <a href="{% url 'index' %}">
    <div class="header_icon">
      <img src="{% static 'images/home_page.png' %}">
      <p>A CLUB</p>
    </div>
  </a>
  <a href="{% url 'favourited' %}">
    <div class="header_icon">
      <img src="{% static 'images/fav.png' %}">
      <p>Севимли</p>
    </div>
  </a>
  <a href="{% url 'profile' %}">
    <div class="header_icon">
      <img src="{% static 'images/profile.png' %}">
      <p>Профиль</p>
    </div>
  </a>
  <a href="{% url 'chat' %}">
    <div class="header_icon">
      <img src="{% static 'images/chat.png' %}">
      <p>Чатлар</p>
    </div>
  </a>
</div>

<div class="search_block">
  <a href="{% url 'index' %}"><div class="back_button"></div></a>
  <form class="searcher">
    <img class="search_icon" src="{% static 'images/search icon.png' %}" alt="search" />
    <input class="searcher_block" placeholder="Поиск..." autocomplete="off" type="text" />
  </form>
</div>

<div class="choosed_genre">
  <span class="red">A </span><span id="genre-title"></span>
</div>

<div class="content_body"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const genreId = new URLSearchParams(window.location.search).get('genre_id');
  const genreTitleRaw = new URLSearchParams(window.location.search).get('genre_title');
  const genreTitle = genreTitleRaw?.startsWith('A ') ? genreTitleRaw.slice(2).trim() : genreTitleRaw || '';
  document.getElementById('genre-title').textContent = decodeURIComponent(genreTitle || '');

  const contentBody = document.querySelector('.content_body');
  if (!genreId) return contentBody.innerHTML = '<p>Не указан жанр</p>';

  const favourites = JSON.parse(localStorage.getItem('favourites') || '[]');

  fetch('/api/genres/')
    .then(r => r.json())
    .then(data => {
      const genre = data.find(g => g.id == genreId);
      if (!genre) return contentBody.innerHTML = '<p>Жанр не найден</p>';
      if (genre.items.length === 0) return contentBody.innerHTML = '<p>Контент пока не добавлен</p>';

      contentBody.innerHTML = '';
      genre.items.forEach(item => {
        const isFavourited = favourites.includes(item.id);
        const favClass = isFavourited ? 'favourited' : 'not_favourited';
        const favIcon = `<div class="fav_icon ${favClass}" data-id="${item.id}"></div>`;
        let block = '';

        const open = `window.open('${item.telegram_url}', '_blank')`;

        if (item.content_type === 'video') {
          block = `<div class="video">
            <div class="video_thumbnail" onclick="${open}">
              <img src="${item.thumbnail}" />
              <div class="video_duration">${item.duration}</div>
            </div>
            ${favIcon}
            <div class="video_info"><div class="title">${item.title}</div><div class="subtitle">${item.subtitle || ''}</div></div>
          </div>`;
        } else if (item.content_type === 'audio') {
          block = `<div class="audio" onclick="${open}">
            <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}" /></div>
            <div class="audio_duration">${item.duration}</div>
            ${favIcon}
            <div class="audio_info"><div class="title">${item.title}</div><div class="subtitle">${item.subtitle || ''}</div></div>
          </div>`;
        } else if (item.content_type === 'file') {
          block = `<div class="file" onclick="${open}">
            <div class="static_icon"><img src="{% static 'images/file_icon.png' %}" /></div>
            <div class="file_duration">${item.duration}</div>
            ${favIcon}
            <div class="file_info"><div class="title">${item.title}</div><div class="subtitle">${item.subtitle || ''}</div></div>
          </div>`;
        }

        contentBody.insertAdjacentHTML('beforeend', block);
        const favEl = contentBody.lastElementChild.querySelector('.fav_icon');

        favEl.addEventListener('click', e => {
          e.stopPropagation();
          const id = parseInt(favEl.dataset.id);
          let favs = JSON.parse(localStorage.getItem('favourites') || '[]');
          const popup = document.getElementById('popup');

          if (favEl.classList.contains('favourited')) {
            popup.classList.add('show');
            document.getElementById('popup_yes').onclick = () => {
              favEl.classList.remove('favourited');
              favEl.classList.add('not_favourited');
              favs = favs.filter(f => f !== id);
              localStorage.setItem('favourites', JSON.stringify(favs));
              popup.classList.remove('show');
            };
            document.getElementById('popup_no').onclick = () => popup.classList.remove('show');
          } else {
            favEl.classList.add('favourited');
            favEl.classList.remove('not_favourited');
            favEl.classList.add('animate-pulse');
            setTimeout(() => favEl.classList.remove('animate-pulse'), 600);

            const block = favEl.closest('.video, .audio, .file');
            const explosion = document.createElement('div');
            explosion.classList.add('fav_explosion');
            block.appendChild(explosion);
            setTimeout(() => explosion.remove(), 600);

            favs.push(id);
            localStorage.setItem('favourites', JSON.stringify(favs));
          }
        });
      });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const overlay = document.querySelector('.blur_overlay');
  requestAnimationFrame(() => overlay.classList.remove('active'));
  document.querySelectorAll('.header a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const href = link.getAttribute('href');
      overlay.classList.add('active');
      setTimeout(() => window.location.href = href, 300);
    });
  });
});
</script>

</body>
</html>
