{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .audio_menu, .file_menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

/* === NAVBAR FULL CSS — ICONS + SMALL TEXT (taller capsule + spacing) === */
.header, .header * { 
  box-sizing: border-box !important; 
}

.header {
  position: fixed !important;
  left: 8px !important;
  right: 8px !important;
  bottom: calc(env(safe-area-inset-bottom) + 12px) !important;
  top: auto !important;
  transform: none !important;
  width: auto !important;
  height: 88px !important;             /* бар стал чуть выше */
  padding: 6px 6px !important;
  display: grid !important;
  grid-template-columns: repeat(5, 1fr) !important;
  gap: 6px !important;                 /* немного больше промежуток */
  overflow: hidden !important;
  border-radius: 40px !important;
  background: linear-gradient(45deg, rgba(128,26,48,.16), rgba(78,5,21,.28)) !important;
  border: 1px solid #ffffff44 !important;
  -webkit-backdrop-filter: blur(5px) !important;
  backdrop-filter: blur(5px) !important;
  z-index: 9999 !important;
  align-items: center !important;
}

.header > a {
  display: block !important;
  min-width: 0 !important;
}

.header_icon {
  width: 100% !important;
  height: 100% !important;
  border-radius: 32px !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 6px 0 !important;           /* добавили сверху и снизу */
  gap: 4px !important;                 /* отступ между иконкой и текстом */
  min-width: 0 !important;
}

.header_icon img {
  display: block !important;
  width: 34px !important;
  height: 34px !important;
  margin: 0 !important;
  object-fit: contain !important;
}

.header_icon p {
  margin: 0 !important;
  font-size: 10px !important;
  line-height: 1.1 !important;
  color: #fff !important;
  text-align: center !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

.header_icon.active {
  background-color: #00000066 !important;
  opacity: 1 !important;
  transform: none !important;
  animation: none !important;
}

@media (max-width: 360px) {
  .header {
    height: 80px !important;
    padding: 6px 4px calc(6px + env(safe-area-inset-bottom)) 4px !important;
    gap: 4px !important;
  }
  .header_icon {
    padding: 4px 0 !important;
    gap: 3px !important;
  }
  .header_icon img {
    width: 30px !important;
    height: 30px !important;
  }
  .header_icon p {
    font-size: 9px !important;
  }
}
</style>

</head>
<body>

<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Севимлилардан олиб ташлашни хоҳлайсизми?</p>
    <div class="popup_buttons">
      <button id="popup_yes">ҲА</button>
      <button id="popup_no">ЙЎҚ</button>
    </div>
  </div>
</div>

<div class="blur_overlay active"></div>

<div class="vertical-waves">
  <div class="wave"></div>
  <div class="wave"></div>
  <div class="wave"></div>
</div>

<div class="header">
  <a href="{% url 'index' %}">
    <div class="header_icon">
      <img src="{% static 'images/home_page.png' %}" alt="Home">
      <p>A CLUB</p>
    </div>
  </a>
  <a href="{% url 'favourited' %}">
    <div class="header_icon">
      <img src="{% static 'images/fav.png' %}" alt="Fav">
      <p>Севимли</p>
    </div>
  </a>
  <a href="{% url 'profile' %}">
    <div class="header_icon">
      <img src="{% static 'images/profile.png' %}" alt="Profile">
      <p>Профиль</p>
    </div>
  </a>
  <a href="{% url 'chat' %}">
    <div class="header_icon">
      <img src="{% static 'images/chat.png' %}" alt="Chat">
      <p>Чатлар</p>
    </div>
  </a>
  <a href="{% url 'rules' %}">
    <div class="header_icon">
      <img src="{% static 'images/rules.png' %}" alt="Rules">
      <p>Қоидалар</p>
    </div>
  </a>
</div>

<div class="search_block">
  <a href="{% url 'index' %}"><div class="back_button"></div></a>
  <form class="searcher">
    <img class="search_icon" src="{% static 'images/search icon.png' %}">
    <input class="searcher_block" placeholder="Қидириш..." autocomplete="off">
  </form>
</div>

<div class="choosed_genre">
  <span class="red">A </span><span id="genre-title"></span>
</div>

<div class="content_body"></div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // --- Получаем lastTitle из last_session
  const session = localStorage.getItem('last_session');
  const lastTitle = session ? JSON.parse(session).itemTitle : null;

  // --- Получаем пользователя
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  if (!user || !user.id) return document.querySelector('.content_body').innerHTML = '<p>Ошибка авторизации</p>';

  // --- Получаем параметры жанра из URL
  const genreId = new URLSearchParams(window.location.search).get('genre_id');
  const genreTitleRaw = new URLSearchParams(window.location.search).get('genre_title');
  const genreTitle = genreTitleRaw?.startsWith('A ') ? genreTitleRaw.slice(2).trim() : genreTitleRaw || '';
  document.getElementById('genre-title').textContent = decodeURIComponent(genreTitle || '');

  const contentBody = document.querySelector('.content_body');
  if (!genreId) return contentBody.innerHTML = '<p>Не указан жанр</p>';

  // --- Получаем избранное
  const favRes = await fetch(`/api/favourites/?telegram_id=${user.id}`);
  const favData = await favRes.json();
  const favourites = favData.favourites || [];

  // --- Получаем список жанров
  const res = await fetch('/api/genres/');
  const genres = await res.json();
  const genre = genres.find(g => g.id == genreId);
  if (!genre || !genre.items.length) return contentBody.innerHTML = '<p>Ҳозирча контент юкланмади</p>';

  const allCards = [];

  // --- Рендерим карточки
  genre.items.forEach(item => {
    const isFavourited = favourites.includes(item.id);
    const favClass = isFavourited ? 'favourited' : 'not_favourited';
    const favIcon = `<div class="fav_icon ${favClass}" data-id="${item.id}"></div>`;
    const open = `openTelegramAndCollapse('${item.telegram_url}', '${genre.id}', '${genre.title}', '${item.title}', '${item.id}')`;

    let block = '';
    if (item.content_type === 'video') {
      block = `<div class="video">
        <div class="video_thumbnail" onclick="${open}">
          <img src="${item.thumbnail}" />
          <div class="video_duration">${item.duration}</div>
        </div>
        ${favIcon}
        <div class="video_info"><div class="title">${item.title}</div><div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g, '<br>') : ''}</div></div>
      </div>`;
    } else if (item.content_type === 'audio') {
      block = `<div class="audio" onclick="${open}">
        <div class="audio_menu">
          <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}" /></div>
          <div class="audio_duration">${item.duration}</div>
        </div>
        ${favIcon}
        <div class="audio_info"><div class="title">${item.title}</div><div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g, '<br>') : ''}</div></div>
      </div>`;
    } else if (item.content_type === 'file') {
      block = `<div class="file" onclick="${open}">
        <div class="file_menu">
          <div class="static_icon"><img src="{% static 'images/file_icon.png' %}" /></div>
          <div class="file_duration">${item.duration}</div>
        </div>
        ${favIcon}
        <div class="file_info"><div class="title">${item.title}</div><div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g, '<br>') : ''}</div></div>
      </div>`;
    }

    contentBody.insertAdjacentHTML('beforeend', block);
    const favEl = contentBody.lastElementChild.querySelector('.fav_icon');
    allCards.push(item);

    favEl.addEventListener('click', async e => {
      e.stopPropagation();
      const id = parseInt(favEl.dataset.id);
      const popup = document.getElementById('popup');

      if (favEl.classList.contains('favourited')) {
        popup.classList.add('show');
        document.getElementById('popup_yes').onclick = async () => {
          await fetch(`/api/favourites/remove/${id}/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telegram_id: user.id })
          });
          favEl.classList.remove('favourited');
          favEl.classList.add('not_favourited');
          popup.classList.remove('show');
        };
        document.getElementById('popup_no').onclick = () => popup.classList.remove('show');
      } else {
        await fetch(`/api/favourites/add/${id}/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: user.id })
        });

        favEl.classList.remove('not_favourited');
        favEl.classList.add('favourited');
        favEl.classList.add('animate-pulse');
        setTimeout(() => favEl.classList.remove('animate-pulse'), 600);

        const block = favEl.closest('.video, .audio, .file');
        const explosion = document.createElement('div');
        explosion.classList.add('fav_explosion');
        block.appendChild(explosion);
        setTimeout(() => explosion.remove(), 600);
      }
    });
  });

  localStorage.setItem('allCards', JSON.stringify(allCards));

  // --- Скроллим к карточке по title строго по тексту!
  if (lastTitle) {
    setTimeout(() => {
      const cards = document.querySelectorAll('.video, .audio, .file');
      for (let card of cards) {
        const titleEl = card.querySelector('.title');
        if (titleEl && titleEl.textContent.trim() === lastTitle.trim()) {
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
          localStorage.removeItem('last_session');
          break;
        }
      }
    }, 300);
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const overlay = document.querySelector('.blur_overlay');
  requestAnimationFrame(() => overlay.classList.remove('active'));
  document.querySelectorAll('.header a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const href = link.getAttribute('href');
      overlay.classList.add('active');
      setTimeout(() => window.location.href = href, 300);
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector(".searcher");
  const input = document.querySelector(".searcher_block");

  if (!form || !input) {
    console.error("⛔ Поисковая форма не найдена");
    return;
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const query = input.value.trim();
    if (query) {
      const encoded = encodeURIComponent(query);
      window.location.href = `/searched/?query=${encoded}`;
    }
  });
});
</script>

<script>
function openTelegramAndCollapse(url, genreId, genreTitle, itemTitle, itemId) {
  localStorage.setItem('last_session', JSON.stringify({
    genreId,
    genreTitle,
    itemTitle,
    itemId
  }));

  window.location.href = url;

  setTimeout(() => {
    try {
      Telegram.WebApp.close();
    } catch (e) {
      console.warn("Не удалось закрыть мини-апп:", e);
    }
  }, 500);
}
</script>

</body>
</html>
