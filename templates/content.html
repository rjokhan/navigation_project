{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .audio_menu, .file_menu { display:flex; flex-direction:column; align-items:center; justify-content:center; }

    /* NAVBAR */
    .header, .header * { box-sizing:border-box !important; }
    .header {
      position:fixed !important; bottom:calc(env(safe-area-inset-bottom) + 12px) !important; left:50% !important; transform:translateX(-50%) !important;
      width:calc(100vw - 16px) !important; max-width:640px !important; height:88px !important; padding:4px !important;
      display:grid !important; grid-template-columns:repeat(5,1fr) !important; gap:6px !important; overflow:hidden !important;
      border-radius:40px !important; background:linear-gradient(45deg, rgba(128,26,48,.16), rgba(78,5,21,.28)) !important;
      border:1px solid #ffffff44 !important; -webkit-backdrop-filter:blur(5px) !important; backdrop-filter:blur(5px) !important; z-index:9999 !important;
    }
    .header>a{display:block !important; min-width:0 !important; height:100% !important;}
    .header_icon{width:100% !important; height:100% !important; border-radius:32px !important; display:flex !important; flex-direction:column !important; align-items:center !important; justify-content:center !important; padding:8px 0 !important; gap:6px !important;}
    .header_icon img{display:block !important; width:34px !important; height:34px !important; object-fit:contain !important;}
    .header_icon p{margin:0 !important; font-size:10px !important; line-height:1.2 !important; color:#fff !important; text-align:center !important;}
    .header_icon.active{background:#0006 !important;}
    @media (max-width:360px){ .header{height:80px !important; gap:4px !important;} .header_icon img{width:30px !important; height:30px !important;} .header_icon p{font-size:9px !important;} }

    html,body{margin:0 !important; padding-bottom:100px !important;}

    /* FILTER BAR */
    .filter_bar{
    display:flex;
    gap:12px;
    padding:10px 12px 0 12px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .filter_bar::-webkit-scrollbar{ display:none; }

  .filter_btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:8px 14px;
    border-radius:999px;
    border:2px solid #ff155d;
    background:#ff155d;            /* розовый фон как на макете */
    color:#fff;
    font:600 14px/1 Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    white-space:nowrap;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color:transparent;
    transition:transform .12s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    box-shadow:0 4px 14px rgba(255,21,93,.25);
  }
  .filter_btn:active{ transform:translateY(1px) scale(.98); }

  /* иконка в кружке слева */
  .filter_btn .ico{
    width:22px; height:22px;
    border-radius:999px;
    background:rgba(255,255,255,.18);
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 22px;
  }
  .filter_btn .ico img{
    width:12px; height:12px; display:block;
    filter:brightness(0) invert(1); /* делаем PNG белым */
  }
  .filter_btn .lbl{ letter-spacing:.2px; }

  /* неактивную сделаем полупрозрачной/обведённой */
  .filter_btn.ghost{
    background:transparent;
    color:#ff155d;
    box-shadow:none;
  }
  .filter_btn.ghost .ico{ background:#ff155d; }
  .filter_btn.ghost .ico img{ filter:brightness(0) invert(1); }

  /* «фейковая» (фильтр) — круглая как в референсе */
  .filter_btn.fake{
    padding:8px;
    width:42px; height:42px;
    border-radius:999px;
    justify-content:center;
  }
  .filter_btn.fake .lbl{ display:none; }

    /* Toast */
    #toast{position:fixed; top:-56px; left:50%; transform:translateX(-50%); background:#38b000; color:#fff; font-size:14px; font-weight:600; padding:10px 16px; border-radius:999px; box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:10000; transition:top .35s;}
    #toast.show{top:18px;}

    /* Debug footer */
    #debugbar{position:fixed; left:8px; right:8px; bottom:calc(env(safe-area-inset-bottom) + 100px); font:12px/1.35 Inter,sans-serif; color:#fff; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:6px 8px; display:none; z-index:99999;}
    #debugbar .warn{color:#ffd166;} #debugbar .err{color:#ff6b6b;} #debugbar .ok{color:#a0ffb0;}
  </style>
</head>
<body>

<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Севимлилардан олиб ташлашни хоҳлайсизми?</p>
    <div class="popup_buttons">
      <button id="popup_yes">ҲА</button>
      <button id="popup_no">ЙЎҚ</button>
    </div>
  </div>
</div>

<div class="blur_overlay active"></div>

<div class="vertical-waves"><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>

<div class="header">
  <a href="{% url 'index' %}"><div class="header_icon"><img src="{% static 'images/home_page.png' %}" alt="Home"><p>A CLUB</p></div></a>
  <a href="{% url 'favourited' %}"><div class="header_icon"><img src="{% static 'images/fav.png' %}" alt="Fav"><p>Севимли</p></div></a>
  <a href="{% url 'profile' %}"><div class="header_icon"><img src="{% static 'images/profile.png' %}" alt="Profile"><p>Профиль</p></div></a>
  <a href="{% url 'chat' %}"><div class="header_icon"><img src="{% static 'images/chat.png' %}" alt="Chat"><p>Чатлар</p></div></a>
  <a href="{% url 'rules' %}"><div class="header_icon"><img src="{% static 'images/rules.png' %}" alt="Rules"><p>Қоидалар</p></div></a>
</div>

<div class="search_block">
  <a href="{% url 'index' %}"><div class="back_button"></div></a>
  <form class="searcher">
    <img class="search_icon" src="{% static 'images/search icon.png' %}">
    <input class="searcher_block" placeholder="Қидириш..." autocomplete="off">
  </form>
</div>

<!-- FILTER BAR (ref-style) -->
<div class="filter_bar">
  <button class="filter_btn ghost" data-type="audio">
    <span class="ico"><img src="{% static 'images/audio_icon.png' %}" alt=""></span>
    <span class="lbl">Audio</span>
  </button>
  <button class="filter_btn" data-type="video">
    <span class="ico"><img src="{% static 'images/video_icon.png' %}" alt=""></span>
    <span class="lbl">Video</span>
  </button>
  <button class="filter_btn ghost" data-type="file">
    <span class="ico"><img src="{% static 'images/file_icon.png' %}" alt=""></span>
    <span class="lbl">File</span>
  </button>
  <button class="filter_btn fake" aria-label="Filter">
    <span class="ico"><img src="{% static 'images/filter_icon.png' %}" alt=""></span>
    <span class="lbl">Filter</span>
  </button>
</div>


<div id="toast">Выберите формат фильтра</div>

<div class="choosed_genre"><span class="red">A </span><span id="genre-title"></span></div>

<div class="content_body"></div>

<!-- tiny debug footer -->
<div id="debugbar"></div>

<script>
/* ---------- РЕНДЕР КАРТОЧЕК ---------- */
function renderItems(container, items, favourites, genreId, genreTitle) {
  container.innerHTML = '';
  items.forEach(item => {
    const isFav = favourites.includes(item.id);
    const favClass = isFav ? 'favourited' : 'not_favourited';
    const favIcon = `<div class="fav_icon ${favClass}" data-id="${item.id}"></div>`;
    const open = `openTelegramAndCollapse('${item.telegram_url}', '${genreId}', '${genreTitle}', '${(item.title||'').replace(/'/g,"&#39;")}', '${item.id}')`;

    let block = '';
    if (item.content_type === 'video') {
      block = `<div class="video">
        <div class="video_thumbnail" onclick="${open}">
          <img src="${item.thumbnail || ''}"/>
          <div class="video_duration">${item.duration || ''}</div>
        </div>
        ${favIcon}
        <div class="video_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    } else if (item.content_type === 'audio') {
      block = `<div class="audio" onclick="${open}">
        <div class="audio_menu">
          <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}" /></div>
          <div class="audio_duration">${item.duration || ''}</div>
        </div>
        ${favIcon}
        <div class="audio_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    } else {
      block = `<div class="file" onclick="${open}">
        <div class="file_menu">
          <div class="static_icon"><img src="{% static 'images/file_icon.png' %}" /></div>
          <div class="file_duration">${item.duration || ''}</div>
        </div>
        ${favIcon}
        <div class="file_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    }

    container.insertAdjacentHTML('beforeend', block);
    const favEl = container.lastElementChild.querySelector('.fav_icon');

    favEl.addEventListener('click', async e => {
      e.stopPropagation();
      const id = parseInt(favEl.dataset.id);
      const popup = document.getElementById('popup');

      if (favEl.classList.contains('favourited')) {
        popup.classList.add('show');
        document.getElementById('popup_yes').onclick = async () => {
          await fetch(`/api/favourites/remove/${id}/`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ telegram_id: window.__uid })
          });
          favEl.classList.remove('favourited'); favEl.classList.add('not_favourited');
          popup.classList.remove('show');
        };
        document.getElementById('popup_no').onclick = () => popup.classList.remove('show');
      } else {
        await fetch(`/api/favourites/add/${id}/`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({ telegram_id: window.__uid })
        });
        favEl.classList.remove('not_favourited'); favEl.classList.add('favourited');
        favEl.classList.add('animate-pulse'); setTimeout(() => favEl.classList.remove('animate-pulse'), 600);
        const host = favEl.closest('.video, .audio, .file');
        const explosion = document.createElement('div'); explosion.classList.add('fav_explosion'); host.appendChild(explosion); setTimeout(() => explosion.remove(), 600);
      }
    });
  });
}

/* ---------- ВСПОМОГАТЕЛЬНОЕ: парсер ответов ---------- */
function pickItems(json){
  if (!json) return [];
  if (Array.isArray(json)) return json;
  if (Array.isArray(json.items)) return json.items;
  if (Array.isArray(json.results)) return json.results;
  // иногда прилетает {data:[...]}
  if (Array.isArray(json.data)) return json.data;
  return [];
}
</script>

<script>
/* ---------- ОСНОВНАЯ ЛОГИКА ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  const DEBUG = true;
  const dbg = document.getElementById('debugbar');
  const dlog = (msg, cls='ok') => { if(!DEBUG) return; dbg.style.display='block'; const s=document.createElement('span'); s.className=cls; s.style.marginRight='10px'; s.textContent=msg; dbg.appendChild(s); };

  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  if (!user || !user.id) { document.querySelector('.content_body').innerHTML = '<p>Ошибка авторизации</p>'; return; }
  window.__uid = user.id;

  const qs = new URLSearchParams(location.search);
  const genreId = qs.get('genre_id');
  const genreTitleRaw = qs.get('genre_title');
  const genreTitle = genreTitleRaw?.startsWith('A ') ? genreTitleRaw.slice(2).trim() : (genreTitleRaw || '');
  document.getElementById('genre-title').textContent = decodeURIComponent(genreTitle || '');

  const contentBody = document.querySelector('.content_body');
  if (!genreId) { contentBody.innerHTML = '<p>Не указан жанр</p>'; return; }

  // избранное
  let favourites = [];
  try {
    const favRes = await fetch(`/api/favourites/?telegram_id=${encodeURIComponent(user.id)}`, { credentials: 'same-origin' });
    const favData = await favRes.json();
    favourites = favData?.favourites || [];
  } catch (e) { dlog('fav error','warn'); }

  // функция запроса по списку возможных URL
  async function fetchItemsByAny(urls){
    for (const u of urls) {
      try{
        const r = await fetch(u, { credentials:'same-origin' });
        dlog(`${r.status} ${u}`, r.ok?'ok':'warn');
        if(!r.ok) continue;
        const j = await r.json();
        const items = pickItems(j);
        return { items, used: u, raw: j };
      }catch(e){
        dlog(`ERR ${u}: ${e.message}`, 'err');
      }
    }
    return { items: [], used: null, raw: null };
  }

  // загрузка и рендер (с фолбэками)
  async function fetchAndRender(type){
    contentBody.innerHTML = '<div class="loading">Юкланяпти...</div>';

    const id = encodeURIComponent(genreId);
    const t  = type ? `&content_type=${encodeURIComponent(type)}` : '';

    // основной и фолбэки
    const urls = [
      `/api/genres/${id}/content/?page=1${t}`,       // наш основной
      `/api/content/${id}/?page=1${t}`,              // альтернативный
      `/api/content/?genre_id=${id}&page=1${t}`,     // старый вариант
      `/api/contents/?genre_id=${id}&page=1${t}`     // ещё один старый
    ];

    const {items, used} = await fetchItemsByAny(urls);

    if (!items.length) {
      contentBody.innerHTML = '<p>Ҳозирча контент юкланмади</p>';
      if (DEBUG) dlog('no items','warn');
      return;
    }

    renderItems(contentBody, items, favourites, genreId, genreTitle);
    if (DEBUG && used) dlog(`USED ${used}`, 'ok');

    // скролл к последней карточке, если есть last_session
    const session = localStorage.getItem('last_session');
    const lastTitle = session ? JSON.parse(session).itemTitle : null;
    if (lastTitle) {
      setTimeout(() => {
        const cards = document.querySelectorAll('.video, .audio, .file');
        for (let card of cards) {
          const t = card.querySelector('.title');
          if (t && t.textContent.trim() === lastTitle.trim()) {
            card.scrollIntoView({ behavior:'smooth', block:'start' });
            localStorage.removeItem('last_session');
            break;
          }
        }
      }, 300);
    }
  }

  // первая загрузка
  await fetchAndRender();

  // FILTER UI
  const toast = document.getElementById('toast');
  const btns  = document.querySelectorAll('.filter_btn');

  function setActive(btn){ btns.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }

  btns.forEach(btn => {
    btn.addEventListener('click', async () => {
      if (btn.classList.contains('fake')) {
        toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2000); return;
      }
      setActive(btn);
      await fetchAndRender(btn.dataset.type); // audio | video | file
    });
  });
});
</script>

<script>
/* UX: плавные переходы, поиск */
document.addEventListener('DOMContentLoaded', () => {
  const overlay = document.querySelector('.blur_overlay');
  requestAnimationFrame(() => overlay.classList.remove('active'));
  document.querySelectorAll('.header a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const href = link.getAttribute('href');
      overlay.classList.add('active');
      setTimeout(() => window.location.href = href, 300);
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector(".searcher");
  const input = document.querySelector(".searcher_block");
  if (!form || !input) return;
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const query = input.value.trim();
    if (query) window.location.href = `/searched/?query=${encodeURIComponent(query)}`;
  });
});
</script>

<script>
function openTelegramAndCollapse(url, genreId, genreTitle, itemTitle, itemId) {
  localStorage.setItem('last_session', JSON.stringify({ genreId, genreTitle, itemTitle, itemId }));
  window.location.href = url;
  setTimeout(() => { try { Telegram.WebApp.close(); } catch(e) {} }, 500);
}
</script>

<script>
  // ...после определения fetchAndRender(...)
  const toast = document.getElementById('toast');
  const btns = document.querySelectorAll('.filter_btn');

  function setActive(btn){
    btns.forEach(b=>{
      if(b.classList.contains('fake')) return;
      b.classList.add('ghost');     // все в неактив
    });
    btn.classList.remove('ghost');   // текущий актив
  }

  btns.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(btn.classList.contains('fake')){
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 2000);
        return;
      }
      setActive(btn);
      const type = btn.dataset.type; // audio | video | file
      await fetchAndRender(type);
    });
  });
</script>


</body>
</html>
