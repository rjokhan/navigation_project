{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .audio_menu, .file_menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Севимлилардан олиб ташлашни хоҳлайсизми?</p>
    <div class="popup_buttons">
      <button id="popup_yes">ҲА</button>
      <button id="popup_no">ЙЎҚ</button>
    </div>
  </div>
</div>

<div class="blur_overlay active"></div>

<div class="vertical-waves">
  <div class="wave"></div>
  <div class="wave"></div>
  <div class="wave"></div>
</div>

<div class="header">
  <a href="{% url 'index' %}">
    <div class="header_icon">
      <img src="{% static 'images/home_page.png' %}">
      <p>A CLUB</p>
    </div>
  </a>
  <a href="{% url 'favourited' %}">
    <div class="header_icon">
      <img src="{% static 'images/fav.png' %}">
      <p>Севимли</p>
    </div>
  </a>
  <a href="{% url 'profile' %}">
    <div class="header_icon">
      <img src="{% static 'images/profile.png' %}">
      <p>Профиль</p>
    </div>
  </a>
  <a href="{% url 'chat' %}">
    <div class="header_icon">
      <img src="{% static 'images/chat.png' %}">
      <p>Чатлар</p>
    </div>
  </a>
</div>

<div class="search_block">
    <a href="{% url 'index' %}"><div class="back_button"></div></a>
    <form class="searcher">
      <img class="search_icon" src="{% static 'images/search icon.png' %}">
      <input class="searcher_block" placeholder="Поиск..." autocomplete="off">
  </form>
</div>

<div class="choosed_genre">
  <span class="red">A </span><span id="genre-title"></span>
</div>

<div class="content_body"></div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const session = localStorage.getItem('last_session');
  const lastTitle = session ? JSON.parse(session).itemTitle : null;

  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  if (!user || !user.id) return document.querySelector('.content_body').innerHTML = '<p>Ошибка авторизации</p>';

  const genreId = new URLSearchParams(window.location.search).get('genre_id');
  const genreTitleRaw = new URLSearchParams(window.location.search).get('genre_title');
  const genreTitle = genreTitleRaw?.startsWith('A ') ? genreTitleRaw.slice(2).trim() : genreTitleRaw || '';
  document.getElementById('genre-title').textContent = decodeURIComponent(genreTitle || '');

  const contentBody = document.querySelector('.content_body');
  if (!genreId) return contentBody.innerHTML = '<p>Не указан жанр</p>';

  const favRes = await fetch(`/api/favourites/?telegram_id=${user.id}`);
  const favData = await favRes.json();
  const favourites = favData.favourites || [];

  const res = await fetch('/api/genres/');
  const genres = await res.json();
  const genre = genres.find(g => g.id == genreId);
  if (!genre || !genre.items.length) return contentBody.innerHTML = '<p>Контент пока не добавлен</p>';

  genre.items.forEach(item => {
    const favClass = favourites.includes(item.id) ? 'favourited' : 'not_favourited';
    const favIcon = `<div class="fav_icon ${favClass}" data-id="${item.id}"></div>`;
    const open = `openTelegramAndCollapse('${item.telegram_url}', '${genre.id}', '${genre.title}', '${item.title}', '${item.id}')`;

    const cardIdAttr = lastTitle && item.title.trim() === lastTitle.trim() ? 'id="scroll_target_card"' : '';

    const block = `
      <div class="${item.content_type}" ${cardIdAttr}>
        <div class="${item.content_type}_thumbnail" onclick="${open}">
          <img src="${item.thumbnail || '/static/images/file_icon.png'}" />
          <div class="${item.content_type}_duration">${item.duration}</div>
        </div>
        ${favIcon}
        <div class="${item.content_type}_info">
          <div class="title">${item.title}</div>
          <div class="subtitle">${item.subtitle || ''}</div>
        </div>
      </div>`;

    contentBody.insertAdjacentHTML('beforeend', block);
  });

  if (lastTitle) {
    setTimeout(() => {
      document.getElementById('scroll_target_card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      localStorage.removeItem('last_session');
    }, 200);
  }
});
</script>

<script>
function openTelegramAndCollapse(url, genreId, genreTitle, itemTitle, itemId) {
  localStorage.setItem('last_session', JSON.stringify({ genreId, genreTitle, itemTitle, itemId }));
  window.location.href = url;
  setTimeout(() => Telegram.WebApp.close(), 500);
}
</script>

</body>
</html>
