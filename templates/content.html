{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAVIGATION</title>
  <link rel="stylesheet" href="{% static 'css/content.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .audio_menu, .file_menu { display:flex; flex-direction:column; align-items:center; justify-content:center; }

    /* NAVBAR */
    .header, .header * { box-sizing:border-box !important; }
    .header {
      position:fixed !important; bottom:calc(env(safe-area-inset-bottom) + 12px) !important; left:50% !important; transform:translateX(-50%) !important;
      width:calc(100vw - 16px) !important; max-width:640px !important; height:88px !important; padding:4px !important;
      display:grid !important; grid-template-columns:repeat(5,1fr) !important; gap:6px !important; overflow:hidden !important;
      border-radius:40px !important; background:linear-gradient(45deg, rgba(128,26,48,.16), rgba(78,5,21,.28)) !important;
      border:1px solid #ffffff44 !important; -webkit-backdrop-filter:blur(5px) !important; backdrop-filter:blur(5px) !important; z-index:9999 !important;
    }
    .header>a{display:block !important; min-width:0 !important; height:100% !important;}
    .header_icon{width:100% !important; height:100% !important; border-radius:32px !important; display:flex !important; flex-direction:column !important; align-items:center !important; justify-content:center !important; padding:8px 0 !important; gap:6px !important;}
    .header_icon img{display:block !important; width:34px !important; height:34px !important; object-fit:contain !important;}
    .header_icon p{margin:0 !important; font-size:10px !important; line-height:1.2 !important; color:#fff !important; text-align:center !important;}
    .header_icon.active{background:#0006 !important;}
    @media (max-width:360px){ .header{height:80px !important; gap:4px !important;} .header_icon img{width:30px !important; height:30px !important;} .header_icon p{font-size:9px !important;} }

    html,body{margin:0 !important; padding-bottom:100px !important;}

    /* ===== FILTER CHIPS ===== */
    /* сетка: 3 равные кнопки + узкий фильтр */
    .filter_bar{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 48px;
      gap:10px;
      padding:12px 12px 0;
      align-items:center;
    }
    @media (max-width:360px){
      .filter_bar{ gap:8px; grid-template-columns: 1fr 1fr 1fr 44px; }
    }

    .chip{
      min-width:0;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 0px; border-radius:999px;
      border:1px solid #fff;                   /* обводка всегда белая */
      background:transparent;                   /* неактивная — прозрачная */
      color:#fff;                               /* текст белый */
      font:600 15px/1 Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      white-space:nowrap; cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent;
      transition:background .2s ease, transform .1s ease;
    }
    .chip:active{ transform:translateY(1px) scale(.98); }

    .chip__dot{
      width:28px; height:28px; border-radius:50%;
      display:grid; place-items:center; background:#ff155d;   /* неактивная — розовый кружок */
      flex:0 0 24px;
    }
    .chip__icon{ width:15px; height:15px; object-fit:contain; filter:invert(1) brightness(200%); } /* неактивная — иконка белая */

    /* активная — фон розовый, кружок белый, иконка «как есть» */
    .chip.active{ background:#ff155d; }
    .chip.active .chip__dot{ background:#fff; }
    .chip.active .chip__icon{ filter:none; }

    /* маленькая «Filter» — всегда розовая */
    .chip--filter{
      grid-column: 4 / 5;
      padding:10px; width:100%; height:44px; border-radius:999px; justify-content:center;
      background:#ff155d; border:1px solid #fff;
    }
    .chip--filter .chip__dot{ background:transparent; }
    .chip--filter .chip__icon{ filter:none; width:18px; height:18px; }
    .chip--filter span.label{ display:none; } /* без текста */

    @media (max-width:360px){
      .chip{ padding:9px 12px; font-size:14px; gap:8px; }
      .chip__dot{ width:22px; height:22px; }
      .chip--filter{ height:40px; }
    }

    /* Toast */
    #toast{position:fixed; top:-56px; left:50%; transform:translateX(-50%); background:#38b000; color:#fff; font-size:14px; font-weight:600; padding:10px 16px; border-radius:999px; box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:10000; transition:top .35s;}
    #toast.show{top:18px;}

    /* Debug footer (можно скрыть) */
    #debugbar{position:fixed; left:8px; right:8px; bottom:calc(env(safe-area-inset-bottom) + 100px); font:12px/1.35 Inter,sans-serif; color:#fff; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:6px 8px; display:none; z-index:99999;}
    #debugbar .warn{color:#ffd166;} #debugbar .err{color:#ff6b6b;} #debugbar .ok{color:#a0ffb0;}
  </style>
</head>
<body>

<div id="popup" class="confirm_popup">
  <div class="popup_box">
    <p>Севимлилардан олиб ташлашни хоҳлайсизми?</p>
    <div class="popup_buttons">
      <button id="popup_yes">ҲА</button>
      <button id="popup_no">ЙЎҚ</button>
    </div>
  </div>
</div>

<div class="blur_overlay active"></div>

<div class="vertical-waves"><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>

<div class="header">
  <a href="{% url 'index' %}"><div class="header_icon"><img src="{% static 'images/home_page.png' %}" alt="Home"><p>A CLUB</p></div></a>
  <a href="{% url 'favourited' %}"><div class="header_icon"><img src="{% static 'images/fav.png' %}" alt="Fav"><p>Севимли</p></div></a>
  <a href="{% url 'profile' %}"><div class="header_icon"><img src="{% static 'images/profile.png' %}" alt="Profile"><p>Профиль</p></div></a>
  <a href="{% url 'chat' %}"><div class="header_icon"><img src="{% static 'images/chat.png' %}" alt="Chat"><p>Чатлар</p></div></a>
  <a href="{% url 'rules' %}"><div class="header_icon"><img src="{% static 'images/rules.png' %}" alt="Rules"><p>Қоидалар</p></div></a>
</div>

<div class="search_block">
  <a href="{% url 'index' %}"><div class="back_button"></div></a>
  <form class="searcher">
    <img class="search_icon" src="{% static 'images/search icon.png' %}">
    <input class="searcher_block" placeholder="Қидириш..." autocomplete="off">
  </form>
</div>

<!-- ===== FILTER BAR ===== -->
<div class="filter_bar" id="filterBar">
  <button class="chip" data-type="audio" aria-pressed="false">
    <span class="chip__dot">
      <!-- Иконка ТОЛЬКО для фильтра (новая) -->
      <img class="chip__icon" src="{% static 'images/ic_audio2.png' %}" alt="">
    </span>
    <span>Audio</span>
  </button>

  <button class="chip" data-type="video" aria-pressed="false">
    <span class="chip__dot">
      <img class="chip__icon" src="{% static 'images/ic_video2.png' %}" alt="">
    </span>
    <span>Video</span>
  </button>

  <button class="chip" data-type="file" aria-pressed="false">
    <span class="chip__dot">
      <img class="chip__icon" src="{% static 'images/ic_file2.png' %}" alt="">
    </span>
    <span>File</span>
  </button>

  <button class="chip chip--filter" id="chipFilter" aria-label="Filter">
    <span class="chip__dot">
      <img class="chip__icon" src="{% static 'images/ic_filter2.png' %}" alt="">
    </span>
    <span class="label">Filter</span>
  </button>
</div>

<div id="toast">Выберите формат фильтра</div>

<div class="choosed_genre"><span class="red">A </span><span id="genre-title"></span></div>

<div class="content_body"></div>

<!-- tiny debug footer -->
<div id="debugbar"></div>

<script>
/* ---------- РЕНДЕР КАРТОЧЕК (иконки контента — КАК БЫЛО) ---------- */
function renderItems(container, items, favourites, genreId, genreTitle) {
  container.innerHTML = '';
  items.forEach(item => {
    const isFav = favourites.includes(item.id);
    const favClass = isFav ? 'favourited' : 'not_favourited';
    const safeTitle = String(item.title || '').replace(/'/g,"&#39;");
    const open = `openTelegramAndCollapse('${item.telegram_url}', '${genreId}', '${genreTitle}', '${safeTitle}', '${item.id}')`;

    let block = '';
    if (item.content_type === 'video') {
      block = `<div class="video">
        <div class="video_thumbnail" onclick="${open}">
          <img src="${item.thumbnail || ''}"/>
          <div class="video_duration">${item.duration || ''}</div>
        </div>
        <div class="fav_icon ${favClass}" data-id="${item.id}"></div>
        <div class="video_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    } else if (item.content_type === 'audio') {
      block = `<div class="audio" onclick="${open}">
        <div class="audio_menu">
          <!-- СТАРАЯ иконка аудио, как просил -->
          <div class="static_icon"><img src="{% static 'images/audio_icon.png' %}" /></div>
          <div class="audio_duration">${item.duration || ''}</div>
        </div>
        <div class="fav_icon ${favClass}" data-id="${item.id}"></div>
        <div class="audio_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    } else {
      block = `<div class="file" onclick="${open}">
        <div class="file_menu">
          <!-- СТАРАЯ иконка файла, как просил -->
          <div class="static_icon"><img src="{% static 'images/file_icon.png' %}" /></div>
          <div class="file_duration">${item.duration || ''}</div>
        </div>
        <div class="fav_icon ${favClass}" data-id="${item.id}"></div>
        <div class="file_info">
          <div class="title">${item.title || ''}</div>
          <div class="subtitle">${item.subtitle ? item.subtitle.replace(/\n/g,'<br>') : ''}</div>
        </div>
      </div>`;
    }

    container.insertAdjacentHTML('beforeend', block);
    const favEl = container.lastElementChild.querySelector('.fav_icon');

    favEl.addEventListener('click', async e => {
      e.stopPropagation();
      const id = parseInt(favEl.dataset.id);
      const popup = document.getElementById('popup');

      if (favEl.classList.contains('favourited')) {
        popup.classList.add('show');
        document.getElementById('popup_yes').onclick = async () => {
          await fetch(`/api/favourites/remove/${id}/`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ telegram_id: window.__uid })
          });
          favEl.classList.remove('favourited'); favEl.classList.add('not_favourited');
          popup.classList.remove('show');
        };
        document.getElementById('popup_no').onclick = () => popup.classList.remove('show');
      } else {
        await fetch(`/api/favourites/add/${id}/`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({ telegram_id: window.__uid })
        });
        favEl.classList.remove('not_favourited'); favEl.classList.add('favourited');
        favEl.classList.add('animate-pulse'); setTimeout(() => favEl.classList.remove('animate-pulse'), 600);
        const host = favEl.closest('.video, .audio, .file');
        const explosion = document.createElement('div'); explosion.classList.add('fav_explosion'); host.appendChild(explosion); setTimeout(() => explosion.remove(), 600);
      }
    });
  });
}

/* универсальный «достань items из любого ответа» */
function pickItems(json){
  if (!json) return [];
  if (Array.isArray(json)) return json;
  if (Array.isArray(json.items)) return json.items;
  if (Array.isArray(json.results)) return json.results;
  if (Array.isArray(json.data)) return json.data;
  return [];
}
</script>

<script>
/* ---------- ОСНОВНАЯ ЛОГИКА ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  const DEBUG = true;
  const dbg = document.getElementById('debugbar');
  const dlog = (msg, cls='ok') => { if(!DEBUG) return; dbg.style.display='block'; const s=document.createElement('span'); s.className=cls; s.style.marginRight='10px'; s.textContent=msg; dbg.appendChild(s); };

  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  if (!user || !user.id) { document.querySelector('.content_body').innerHTML = '<p>Ошибка авторизации</p>'; return; }
  window.__uid = user.id;

  const qs = new URLSearchParams(location.search);
  const genreId = qs.get('genre_id');
  const genreTitleRaw = qs.get('genre_title');
  const genreTitle = genreTitleRaw?.startsWith('A ') ? genreTitleRaw.slice(2).trim() : (genreTitleRaw || '');
  document.getElementById('genre-title').textContent = decodeURIComponent(genreTitle || '');

  const contentBody = document.querySelector('.content_body');
  if (!genreId) { contentBody.innerHTML = '<p>Не указан жанр</p>'; return; }

  // избранное
  let favourites = [];
  try {
    const favRes = await fetch(`/api/favourites/?telegram_id=${encodeURIComponent(user.id)}`, { credentials: 'same-origin' });
    const favData = await favRes.json();
    favourites = favData?.favourites || [];
  } catch (e) { dlog('fav error','warn'); }

  // функция запроса по списку возможных URL
  async function fetchItemsByAny(urls){
    for (const u of urls) {
      try{
        const r = await fetch(u, { credentials:'same-origin' });
        dlog(`${r.status} ${u}`, r.ok?'ok':'warn');
        if(!r.ok) continue;
        const j = await r.json();
        const items = pickItems(j);
        return { items, used: u, raw: j };
      }catch(e){
        dlog(`ERR ${u}: ${e.message}`, 'err');
      }
    }
    return { items: [], used: null, raw: null };
  }

  // загрузка и рендер (с фолбэками)
  async function fetchAndRender(type){
    contentBody.innerHTML = '<div class="loading">Юкланяпти...</div>';

    const id = encodeURIComponent(genreId);
    const t  = type ? `&content_type=${encodeURIComponent(type)}` : '';

    const urls = [
      `/api/genres/${id}/content/?page=1${t}`,       // основной
      `/api/content/${id}/?page=1${t}`,              // альтернативный 1
      `/api/content/?genre_id=${id}&page=1${t}`,     // альтернативный 2
      `/api/contents/?genre_id=${id}&page=1${t}`     // альтернативный 3
    ];

    const {items, used} = await fetchItemsByAny(urls);

    if (!items.length) {
      contentBody.innerHTML = '<p>Ҳозирча контент юкланмади</p>';
      if (DEBUG) dlog('no items','warn');
      return;
    }

    renderItems(contentBody, items, favourites, genreId, genreTitle);
    if (DEBUG && used) dlog(`USED ${used}`, 'ok');

    // скролл к последней карточке
    const session = localStorage.getItem('last_session');
    const lastTitle = session ? JSON.parse(session).itemTitle : null;
    if (lastTitle) {
      setTimeout(() => {
        const cards = document.querySelectorAll('.video, .audio, .file');
        for (let card of cards) {
          const t = card.querySelector('.title');
          if (t && t.textContent.trim() === lastTitle.trim()) {
            card.scrollIntoView({ behavior:'smooth', block:'start' });
            localStorage.removeItem('last_session');
            break;
          }
        }
      }, 300);
    }
  }

  // первая загрузка
  await fetchAndRender();

  /* ====== Обработчики фильтров ====== */
  const bar = document.getElementById('filterBar');
  const chips = [...bar.querySelectorAll('.chip:not(.chip--filter)')];
  const filterBtn = document.getElementById('chipFilter');
  const toast = document.getElementById('toast');

  function setActiveChip(el){
    chips.forEach(c => { c.classList.toggle('active', c===el); c.setAttribute('aria-pressed', c===el ? 'true' : 'false'); });
  }

  chips.forEach(chip => {
    chip.addEventListener('click', async () => {
      const t = chip.dataset.type;  // audio | video | file
      setActiveChip(chip);
      await fetchAndRender(t);
    });
  });

  filterBtn.addEventListener('click', () => {
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  });
});
</script>

<script>
/* UX: плавные переходы, поиск */
document.addEventListener('DOMContentLoaded', () => {
  const overlay = document.querySelector('.blur_overlay');
  requestAnimationFrame(() => overlay.classList.remove('active'));
  document.querySelectorAll('.header a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const href = link.getAttribute('href');
      overlay.classList.add('active');
      setTimeout(() => window.location.href = href, 300);
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector(".searcher");
  const input = document.querySelector(".searcher_block");
  if (!form || !input) return;
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const query = input.value.trim();
    if (query) window.location.href = `/searched/?query=${encodeURIComponent(query)}`;
  });
});
</script>

<script>
function openTelegramAndCollapse(url, genreId, genreTitle, itemTitle, itemId) {
  localStorage.setItem('last_session', JSON.stringify({ genreId, genreTitle, itemTitle, itemId }));
  window.location.href = url;
  setTimeout(() => { try { Telegram.WebApp.close(); } catch(e) {} }, 500);
}
</script>

</body>
</html>
